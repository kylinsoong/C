= 安装
:toc: manual

本部说明如何在离线环境下如何安装 Nginx Plus 及 Nginx Controller

== Nginx Plus 

=== rpm 同步

本部分需要在连网环境下进行，需要 NGINX Plus 的 License 证书, rpm 包同步完成后拷贝到离线环境。

[source, txt]
.*1. 创建 /etc/ssl/nginx 目录，拷贝证书*
----
# mkdir /etc/ssl/nginx

// copy license cert key to /etc/ssl/nginx 
scp nginx-repo.* root@IP:/etc/ssl/nginx
----

[source, txt]
.*2. 安装 ca-certificates 依赖*
----
yum install ca-certificates -y
----

[source, txt]
.*3. NGINX Plus yum 源配置*
----
wget -P /etc/yum.repos.d https://cs.nginx.com/static/files/nginx-plus-7.4.repo
----

[source, txt]
.*4. 下载 NGINX Plus rpm 包到本地目录*
----
reposync -lmn --repoid=nginx-plus --download_path=/tmp/nginx/

tar -cf nginx-plus.tar nginx-plus/
----

[source, txt]
.*5. 验证下载的 rpm 包*
----
# tar -tf nginx-plus.tar 
nginx-plus/
nginx-plus/RPMS/
nginx-plus/RPMS/nginx-ha-keepalived-2.0.19-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-ha-keepalived-debuginfo-2.0.19-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-nr-agent-2.0.0-12.el7.ngx.noarch.rpm
nginx-plus/RPMS/nginx-plus-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-debuginfo-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-cookie-flag-20+1.1.0-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-cookie-flag-debuginfo-20+1.1.0-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-encrypted-session-20+0.08-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-encrypted-session-debuginfo-20+0.08-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-geoip-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-geoip-debuginfo-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-geoip2-20+3.3-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-geoip2-debuginfo-20+3.3-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-headers-more-20+0.33-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-headers-more-debuginfo-20+0.33-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-image-filter-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-image-filter-debuginfo-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-lua-20+0.10.15-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-lua-debuginfo-20+0.10.15-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-modsecurity-20+1.0.0-11.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-modsecurity-debuginfo-20+1.0.0-11.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-ndk-20+0.3.0-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-ndk-debuginfo-20+0.3.0-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-njs-20+0.3.7-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-njs-debuginfo-20+0.3.7-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-opentracing-20+0.9.0-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-opentracing-debuginfo-20+0.9.0-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-passenger-20+6.0.4-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-passenger-debuginfo-20+6.0.4-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-perl-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-perl-debuginfo-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-prometheus-20+1.2.0-1.el7.ngx.noarch.rpm
nginx-plus/RPMS/nginx-plus-module-rtmp-20+1.2.1-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-rtmp-debuginfo-20+1.2.1-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-set-misc-20+0.32-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-set-misc-debuginfo-20+0.32-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-subs-filter-20+0.6.4-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-subs-filter-debuginfo-20+0.6.4-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-xslt-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-plus-module-xslt-debuginfo-20-1.el7.ngx.x86_64.rpm
nginx-plus/RPMS/nginx-sync-1.1-1.el7.ngx.noarch.rpm
----

=== 本地 YUM 源配置

本部分基于 HTTP Web 服务器(Nginx 或 HTTPD)配置本地 YUM 源。

[source, txt]
.*1. Web 服务器安装*
----
// httpd
yum -y install httpd

// nginx
yum install nginx-plus -y
----

NOTE: 本部分可以两种 Web 服务器选择其一安装即可，如果选择 nginx，可以使用开源版本。

[source, txt]
.*2. 拷贝 rpm 包，本地仓库初始化*
----
mkdir -p /var/www/html/repos

tar -xvf nginx-plus.tar -C /var/www/html/repos

createrepo -v /var/www/html/repos/nginx-plus/ -o /var/www/html/repos/
createrepo --workers=5 /var/www/html/repos/
----

[source, txt]
.*3. Web 服务器配置文件*
----
// nginx
cat << EOF > /etc/nginx/conf.d/yum.conf
server {
        listen   80;
        server_name  yum.example.com;	
        root   /var/www/html/repos;
        location / {
                autoindex on;	
        }
}
EOF

// httpd
cat << EOF > /etc/httpd/conf.d/yum.conf
Alias /repo "/var/www/html/repos"
<Directory "/var/www/html/repos">
  Options +Indexes +FollowSymLinks
  Require all granted
</Directory>
<Location /repo>
  SetHandler None
</Location>
EOF
----

[source, txt]
.*4. 启动 Web 服务器*
----
// nginx
systemctl restart nginx ; systemctl enable nginx ; systemctl status nginx

// httpd
systemctl restart httpd ; systemctl enable httpd ; systemctl status httpd
----

[source, txt]
.*5. 确保 http 服务没有被防火墙阻拦*
----
firewall-cmd --zone=public --permanent --add-service=http
firewall-cmd --reload
----

=== 测试

本部分在内网需要安装 nginx plus 的机器上进行。

[source, txt]
.*1. 配置 yum 源*
----
cat << EOF > /etc/yum.repos.d/nginx.repo
[nginx-plus]
baseurl = http://yum.example.com/repo/nginx-plus
enabled = 1
gpgcheck = 0
name = nginx-plus
EOF
----

[source, txt]
.*2. 安装*
----
yum install nginx-plus -y
systemctl start nginx
----

[source, txt]
.*3. 访问测试*
----
# echo "ok" > /usr/share/nginx/html/hello

# curl http://localhost/hello
ok
----

== Nginx Controller

=== 前序安装

*1. 镜像和许可文件*

在 https://www.nginx.com/free-trial-request-nginx-controller/ 连接里可申请 Free Trial 镜像和许可文件。申请完成后可获得如下文件：

* controller-installer-3.1.0.tar.gz	
* controller_license.txt

*2. 技术参数（所需环境）*

|===
|项目 |参数

|OS
|CentOS 7.7

|RAM
|8 GB

|CPU
|8-Core CPU @ 2.40 GHz

|Disk
|80+ GB
|===

[source, txt]
.*3. 数据库*
----
// Adding PostgreSQL Yum Repository
yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm -y

// install 
yum install postgresql95 postgresql95-server -y

// initialize
/usr/pgsql-9.5/bin/postgresql95-setup initdb

// Config
$ vim /var/lib/pgsql/9.5/data/postgresql.conf
listen_addresses = '*'
$ vim /var/lib/pgsql/9.5/data/pg_hba.conf
host    all             all             0.0.0.0/0               md5

// start & enable
systemctl start postgresql-9.5
systemctl status postgresql-9.5
systemctl enable postgresql-9.5

// Create the user with the Create DB permission
$ sudo passwd postgres

// create user(optional)
su - postgres
createuser db_user
createdb test_db
psql
ALTER USER db_user WITH ENCRYPTED PASSWORD 'db_pass'
ALTER USER db_user CREATEDB
GRANT ALL PRIVILEGES ON DATABASE test_db TO db_user
\q

// disable firewall and seliux
systemctl disable firewalld
systemctl stop firewalld
# getenforce 
Disabled

// test create db
psql -h db.example.com  -p 5432  -U postgres -W
postgres=# CREATE DATABASE test_db;
postgres=# \c test_db;
test_db=# CREATE TABLE users (id int, age int);
test_db-# INSERT INTO users VALUES(1, 18);
test_db=# SELECT * FROM users;

postgres=# DROP DATABASE test_db;
----

[source, txt]
.*4. 安装 utilities*
----
yum install curl wget jq envsubst -y

// bash 4 or above is necessary
bash --version
----

[source, txt]
.*5. docker 版本(Optional)*
----
// (CE) 18.09 or above
docker --version
----

[source, txt]
.*6. Disable swap*
----
# vim /etc/fstab
#/dev/mapper/centos-swap swap                    swap    defaults        0 0
----

=== 安装

[source, txt]
.*1. 拷贝安装文件*
----
$ scp controller* root@192.168.100.81:~

# ls
controller-installer-3.1.0.tar.gz  controller_license.tx
----

[source, txt]
.*2. 解压*
----
tar xzf controller-installer-3.1.0.tar.gz
----

[source, txt]
.*3. 运行安装脚本*
----
cd controller-installer
./install.sh

...

 OK, everything went just fine!
 Thank you for installing NGINX Controller.
 You can find your installation in /opt/nginx-controller.
 You can find the install log file in /var/log/nginx-controller/nginx-controller-install.log.
 Access the system using your web browser at https://nginx-controller.example.com.
 Documentation is available at https://nginx-controller.example.com/docs/.
----

=== 后续安装

[source, txt]
.*1. 查看运行的容器*
----
# kubectl get pods -n nginx-controller -o wide | grep Running
apigw-6cd9c4c86c-2v79v                   2/2     Running     0          9m3s    10.244.0.11   nginx-controller.example.com   <none>           <none>
apimgmt-f95bb768c-6kjzr                  1/1     Running     0          9m3s    10.244.0.7    nginx-controller.example.com   <none>           <none>
appregistry-5b447747d9-pttnh             1/1     Running     0          9m3s    10.244.0.8    nginx-controller.example.com   <none>           <none>
clickhouse-0                             1/1     Running     0          9m2s    10.244.0.20   nginx-controller.example.com   <none>           <none>
cloud-mgr-5476946d6c-xmdck               1/1     Running     0          9m3s    10.244.0.6    nginx-controller.example.com   <none>           <none>
coreapi-84c85dc5b-7s296                  1/1     Running     0          9m3s    10.244.0.9    nginx-controller.example.com   <none>           <none>
cron-5f4887748d-jj8fl                    1/1     Running     0          9m3s    10.244.0.10   nginx-controller.example.com   <none>           <none>
db-consumer-76789ddb8d-j7n2p             1/1     Running     0          9m3s    10.244.0.15   nginx-controller.example.com   <none>           <none>
declarative-ext-api-85bdc4695d-zm9tr     1/1     Running     0          9m2s    10.244.0.12   nginx-controller.example.com   <none>           <none>
events-6666f7748b-lc5fv                  1/1     Running     0          9m2s    10.244.0.14   nginx-controller.example.com   <none>           <none>
frontend-67566d6fcd-nv7t8                1/1     Running     0          9m2s    10.244.0.13   nginx-controller.example.com   <none>           <none>
metrics-59c4b4bbcd-p28mh                 1/1     Running     0          9m2s    10.244.0.16   nginx-controller.example.com   <none>           <none>
nats-79484b8cc8-bbxkm                    1/1     Running     0          9m1s    10.244.0.19   nginx-controller.example.com   <none>           <none>
nats-streaming-7f9b7fd49-n9knx           2/2     Running     0          9m2s    10.244.0.22   nginx-controller.example.com   <none>           <none>
nats-streaming-worker-75676457dd-pvs9q   1/1     Running     0          9m2s    10.244.0.17   nginx-controller.example.com   <none>           <none>
nats-worker-66c576b9f-rd4wt              1/1     Running     0          9m1s    10.244.0.18   nginx-controller.example.com   <none>           <none>
platform-mgr-6474d8c989-lgx9v            1/1     Running     0          9m1s    10.244.0.21   nginx-controller.example.com   <none>           <none>
receiver-845576776-9pmn6                 1/1     Running     0          9m1s    10.244.0.24   nginx-controller.example.com   <none>           <none>
secrets-svc-6c687cdc6-lgdfq              2/2     Running     0          9m      10.244.0.23   nginx-controller.example.com   <none>           <none>
----

*2. 登录 NGINX Controller*

访问 https://nginx-controller.example.com/login，使用安装过程中创建的管理员邮箱和密码（`k.song@example.com`/`f5demo666`），登录成功后进入 license 激活界面。

image:img/controller-license.png[]

NOTE: https://nginx-controller.example.com/docs/ 里有详细关于 NGINX Controller 的文档。

*3. License 激活*

在 license 激活界面选择 controller_license.txt，即可激活，激活后界面如下:

image:img/controller-license-done.png[]

[source, txt] 
.**
----

----

[source, txt] 
.**
----

----

[source, txt] 
.**
----

----

[source, txt] 
.**
----

----

[source, txt] 
.**
----

----

[source, txt] 
.**
----

----
