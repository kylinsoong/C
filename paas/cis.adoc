= F5 Container Ingress Services
:toc: manual

== 前序安装

=== F5 HW/VE 准备

准备 F5 HW/VE， 确保可以工作

=== 创建 partition

在 F5 HW/VE 上创建 partition。

`System` -> `Users` -> `Partition List`, 创建名为 k8s 的 partition。

image:img/f5-ve-partition.png[]

=== AS3 插件安装

使用 https://clouddocs.f5.com/products/extensions/f5-appsvcs-extension/latest/userguide/installation.html[链接] 中提供的三种方法中的任意一种安装 AS3 插件。

[source, json]
.*安装验证*
----
$ curl -k -u admin:admin.F5demo.com https://192.168.1.8/mgmt/shared/appsvcs/info
{
   "version":"3.19.0",
   "release":"4",
   "schemaCurrent":"3.19.0",
   "schemaMinimum":"3.0.0"
}
----

=== 创建 Secret

[source, json]
----
// create
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin.F5demo.com -n kube-system

// verify
kubectl describe secret bigip-login -n kube-system
----

=== RBAC 安全认证

[source, json]
.*1. 创建 Service Account*
---- 
kubectl create serviceaccount bigip-ctlr -n kube-system
----

NOTE: Service Account 确保 Pod 内的容器可以调运 Kubernetes API，具体创建 `bigip-ctlr` 会生成一个 `secret`，`secret` 内保存有证书，Pod 内的容器在调运 Kubernetes API 使用此证书。

*2. 创建*

[source, yaml]
.*rbac-broadest.yaml*
----
cat <<EOF > ./rbac-broadest.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: bigip-ctlr-clusterrole
rules:
- apiGroups: ["", "extensions"]
  resources: ["nodes", "services", "endpoints", "namespaces", "ingresses", "pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["", "extensions"]
  resources: ["configmaps", "events", "ingresses/status"]
  verbs: ["get", "list", "watch", "update", "create", "patch"]
- apiGroups: ["", "extensions"]
  resources: ["secrets"]
  resourceNames: ["bigip-login"]
  verbs: ["get", "list", "watch"]

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: bigip-ctlr-clusterrole-binding
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: bigip-ctlr-clusterrole
subjects:
- apiGroup: ""
  kind: ServiceAccount
  name: bigip-ctlr
  namespace: kube-system
EOF
----

[source, bash]
----
kubectl create -f rbac-broadest.yaml
----

*相关 YAML 下载*

|===
|名称 |描述

|link:files/rbac-broadest.yaml[rbac-broadest.yaml]
|最大权限设定

|===

== 部署

[source, bash]
.*1. 准备 YAML 文件*
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: k8s-bigip-ctlr
  namespace: kube-system
  labels:
    app: k8s-bigip-ctlr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: k8s-bigip-ctlr
  template:
    metadata:
      name: k8s-bigip-ctlr
      labels:
        app: k8s-bigip-ctlr
    spec:
      serviceAccountName: bigip-ctlr
      containers:
        - name: k8s-bigip-ctlr
          image: "f5networks/k8s-bigip-ctlr"
          env:
            - name: BIGIP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: bigip-login
                  key: username
            - name: BIGIP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: bigip-login
                  key: password
          command: ["/app/bin/k8s-bigip-ctlr"]
          args: [
            "--bigip-username=$(BIGIP_USERNAME)",
            "--bigip-password=$(BIGIP_PASSWORD)",
            "--bigip-url=192.168.1.8",
            "--insecure=true",
            "--bigip-partition=k8s",
            "--pool-member-type=cluster"
            ]
----

[source, bash]
.*2. 部署*
----
kubectl create -f deployments.yaml 
----

[source, bash]
.*3. 验证*
----
$ kubectl get pods -n bigip-ctlr --no-headers -o wide
k8s-bigip-ctlr-7b869df6b6-fnqwt   1/1   Running   0     90s   192.168.251.33   machine02.example.com
----

*4. 相关 YAML 下载*

|===
|名称 |描述

|link:files/deployments-basic.yaml[deployments-basic.yaml]
|最小部署

|===

== 业务测试

=== L4

[source, yaml]
.*1. 部署测试容器*
----
// prepare yaml
cat <<EOF > ./mysql.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: mysql
  name: mysql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: mysql
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: f5demo666
EOF

// create
kubectl create -f mysql.yaml

// create svc
kubectl expose deployment mysql --port=3306 --target-port=3306 --name=mysql-svc --type=NodePort
----

[source, yaml]
.*2. ConfigMap 下发 VS*
----
// prepare yaml
cat <<EOF > ./cm-mysql.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: mysql
  labels:
    f5type: virtual-server
data:
  schema: "f5schemadb://bigip-virtual-server_v0.1.7.json"
  data: |-
    {
      "virtualServer": {
        "frontend": {
          "balance": "round-robin",
          "mode": "tcp",
          "partition": "k8s",
          "virtualAddress": {
            "bindAddr": "10.1.10.60",
            "port": 3306
          }
        },
        "backend": {
          "serviceName": "mysql-svc",
          "servicePort": 3306
        }
      }
    }
EOF

// create
kubectl create -f cm-mysql.yaml 
----

[source, yaml]
.*3. TMSH 查看创建的 VS*
----
# cd /k8s/
# list ltm virtual
ltm virtual default_mysql {
    creation-time 2020-05-02:09:20:00
    destination 10.1.10.60%0:mysql
    ip-protocol tcp
    last-modified-time 2020-05-02:09:20:00
    mask 255.255.255.255
    metadata {
        user_agent {
            value k8s-bigip-ctlr-1.14.0-n2285-661543171
        }
    }
    partition k8s
    pool cfgmap_default_mysql_mysql-svc
    profiles {
        /Common/tcp { }
    }
    source 0.0.0.0/0
    source-address-translation {
        type automap
    }
    translate-address enabled
    translate-port enabled
    vs-index 10
}
----

[source, yaml]
.*4. Clean up*
----
kubectl delete -f cm-mysql.yaml
kubectl delete -f mysql.yaml
kubectl delete svc mysql-svc
----


=== L7

[source, yaml]
.*1. 部署测试容器*
----
kubectl create deployment demo-app --image='registry.example.com:5443/f5-hello-world:latest'
kubectl expose deployment demo-app --port=80 --target-port=80 --type=NodePort --name=demo-app-svc
kubectl scale deployments demo-app --replicas=3
----

[source, yaml]
.*2. ConfigMap 下发 VS*
----
cat <<EOF > ./cm-web.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: demo-app
  labels:
    f5type: virtual-server
data:
  schema: "f5schemadb://bigip-virtual-server_v0.1.7.json"
  data: |-
    {
      "virtualServer": {
        "frontend": {
          "balance": "round-robin",
          "mode": "http",
          "partition": "k8s",
          "virtualAddress": {
            "bindAddr": "10.1.10.61",
            "port": 80
          }
        },
        "backend": {
          "serviceName": "demo-app-svc",
          "servicePort": 80,
          "healthMonitors":[{
            "interval": 5,
            "protocol": "http",
            "timeout": 16
          }]
        }
      }
    }
EOF

kubectl create -f cm-web.yaml
----

[source, yaml]
.*3. TMSH 查看创建的 VS* 
----
# cd /k8s/
# list ltm virtual
ltm virtual default_demo-app {
    creation-time 2020-05-02:09:37:19
    destination 10.1.10.61%0:http
    ip-protocol tcp
    last-modified-time 2020-05-02:09:37:19
    mask 255.255.255.255
    metadata {
        user_agent {
            value k8s-bigip-ctlr-1.14.0-n2285-661543171
        }
    }
    partition k8s
    pool cfgmap_default_demo-app_demo-app-svc
    profiles {
        /Common/http { }
        /Common/tcp { }
    }
    source 0.0.0.0/0
    source-address-translation {
        type automap
    }
    translate-address enabled
    translate-port enabled
    vs-index 11
}
----

[source, yaml]
.*4. Clean Up* 
----
kubectl delete -f cm-web.yaml
kubectl delete all --all
----
