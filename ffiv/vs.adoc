= Virtual Server
:toc: manual

== Inbound Traffic Handling

[cols="2,5a"]
|===
|Name |Description

|Self IPs
|使用 external self IP 可以访问管理界面（需要配置 Port Lockdown，允许 443 端口）。

[source, text]
.*查看外部 vlan Self IP*
----
# list net self 10.1.10.240 
net self 10.1.10.240 {
    address 10.1.10.240/24
    allow-service {
        tcp:ssh
        tcp:https
    }
    traffic-group traffic-group-local-only
    vlan external
}
----

*访问管理界面*

https://10.1.10.240

NOTE: 不建议使用业务流量接入的 external vlan 访问系统，推荐使用管理在安装初始化时创建的管理接口访问管理界面

[source, bash]
.*访问 ssh*
----
ssh root@10.1.10.240
----

|NAT
|将内网的地址直接映射到外网，处于监听模式，接收所有发往NAT地址的连接

[source, bash]
----
// create nat
create ltm nat custom_nat originating-address 10.1.20.13 translation-address 10.1.10.100

// make request
curl http://10.1.10.100/hello

// check the connections
# tcpdump -ni external host 10.1.10.100
00:11:43.652881 IP 10.1.10.1.60139 > 10.1.10.100.http: Flags [SEW], ...
# tcpdump -ni internal host 10.1.20.13
00:13:05.685271 IP 10.1.10.1.60216 > 10.1.20.13.http ...

// clean up
delete ltm nat custom_nat
----

|SNATs
|是将某一个 VLAN 上的请求转发到一个地址

[source, bash]
----
// vs is running
create ltm pool http_pool members add { 10.1.20.11:8081 { address 10.1.20.11 } 10.1.20.12:8081 { address 10.1.20.12 } }
create ltm virtual http_vs destination 10.1.10.20:80 ip-protocol tcp pool http_pool

// move 10.1.10.0 to 10.1.20.201
create ltm snat custom_snat origins add { 10.1.10.0/24 } translation 10.1.20.201

// make request
curl http://10.1.10.20/hello

// check the connections
# tcpdump -ni external host 10.1.10.20
00:01:30.871791 IP 10.1.10.1.59532 > 10.1.10.20.http: Flags [SEW], ...
# tcpdump -ni internal host 10.1.20.201
00:02:59.684393 IP 10.1.20.201.35520 > 10.1.20.11.tproxy ...

// clean up
delete ltm virtual http_vs
delete ltm pool http_pool
delete ltm snat custom_snat
----

|Virtual Servers
|
[source, bash]
----
// create VS
create ltm pool http_pool members add { 10.1.20.11:8081 { address 10.1.20.11 } 10.1.20.12:8081 { address 10.1.20.12 } }
create ltm virtual http_vs destination 10.1.10.20:80 ip-protocol tcp pool http_pool

// make request
curl http://10.1.10.20/hello

// check connections
# tcpdump -ni external host 10.1.10.20
00:19:27.352896 IP 10.1.10.1.60544 > 10.1.10.20.http: ...
# tcpdump -ni internal host 10.1.20.11 or 10.1.20.12
00:21:17.840726 IP 10.1.10.1.35715 > 10.1.20.11.tproxy: ...

// Clean up
delete ltm virtual http_vs 
delete ltm pool http_pool
----
|===

== VS Type

[cols="2,5a"]
|===
|Name |Description

|Standard
|

|Forwarding(IP)
|
[source, bash]
----
create ltm virtual forwarding_virtual destination 10.1.20.0:0 mask 255.255.255.0 ip-forward ip-protocol any
----

|Reject
|
[source, bash]
----
create ltm virtual reject_ssh_virtual destination 10.1.20.0:22 mask 255.255.255.0 reject ip-protocol tcp
----

|===
